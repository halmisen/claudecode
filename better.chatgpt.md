# 优化建议（ChatGPT/Codex CLI 代理适配）

> 依据 CLAUDE.md 与 AGENTS.md，总结并定制适配 ChatGPT/Codex CLI 的最佳实践，确保在受限沙箱与审批模式下依然稳健可复现。

## 工具与沙箱适配
- 首选补丁写入：避免“多文件 JSON 输出”，使用逐文件补丁（`apply_patch`）创建/修改文件；需要批量时一次补丁内包含多文件段。
- 渐进式计划：使用 `update_plan` 维护 3–6 步的小计划，保持“恰好一个 in_progress”。在长任务或多阶段实现时更新。
- 读取限制：单次读取控制在 ≤250 行；优先 `rg`，若不可用（常见）回退 `find/grep/sed` 并记录原因。
- 审批与网络：在 `on-request` 且网络受限时，避免需要联网的依赖安装/下载；如确需执行，先解释必要性再请求升级。

## 跨平台命令与路径
- 相对路径优先：避免 `D:\\...` 绝对路径，使用仓库相对路径，兼容 Windows/WSL/macOS/Linux。
- 命令双份示例：文档中同时提供 PowerShell 与 Bash 版本；Python 调用使用 `python -m pip`、`python -m venv` 以降低平台差异。
- Windows 细节：在命令行参数含反斜杠或通配符时给出正确转义与引号示例；生成命令但默认不执行（供用户本地运行）。

## 多文件/批处理工作流
- 触发词与显式开关：沿用 CLAUDE 的多文件意图，但在 ChatGPT 中以“补丁批量”实现；建议用户在请求中加入 `[PATCH]`/`[BATCH]` 标记避免误触发。
- 变更最小化：严格“只改所需”，不随意重构邻近模块；输出中明确列出影响文件路径与目的。
- 回滚友好：按逻辑提交多个较小补丁，必要时便于局部还原。

## 回测命令映射（建议与约束）
- 命令生成为主：在回答中提供可复制的回测命令，但不主动执行；执行前置条件（数据/虚拟环境/依赖）一并列出。
- 参数检查：在生成命令时声明关键参数边界（`--leverage`、`--risk_pct`、`--commission`、`--limit_offset`、`--warmup_bars`、`--slippage`）。
- 路径验证与替代：若数据路径常见不存在，附带下载脚本命令（不执行），并标注预期目标文件路径结构。
- 干跑模式：建议项目支持 `--dry-run` 打印解析后的配置，便于 ChatGPT 在沙箱中验证不执行的情况下完成检查。

## 代码与文档一致性
- 与 AGENTS.md 对齐：
  - 文件命名/结构：策略放 `backtester/strategies`、运行器 `backtester/run_*.py`、测试 `backtester/test_*.py`。
  - 使用 `argparse`、`pathlib` 与 `utils/safe_math.py`；避免零除。
  - 输出一致：结果写入 `results/test_summary.csv`，图表在 `plots/*.html` 并伴随 `.meta.json`。
- 注释与类型：新增/修改代码时补充类型注解与简洁 docstring；保持 4 空格缩进。
- 最小验证脚本：为新增策略补充 `test_*.py` 打印关键指标（权益、交易数、胜率）。

## 质量与安全
- 变更范围控制：不修复无关问题；若发现潜在缺陷，简述风险与建议而不展开修复。
- 数据与密钥：不写入真实凭据；维护 `.env.example`；大型 CSV/ZIP 绝不入库。
- 结果可复现：固定随机种子，输出中标注策略版本与参数；建议在结果/图表的元数据写入版本与生成时间。

## 输出风格（结合 CLI 要求）
- 简洁分段：使用短小标题与要点列表；命令/路径/代码使用反引号包裹。
- 行为前置说明：在执行工具前用 1–2 句说明即将进行的动作；成组动作合并成一次说明。
- 进度播报：长任务每一阶段收尾给出 1 句进度更新与下一步。

---

## ✅ 优化完成状态 (2025-08-19)

以下优化建议已全部实施完成：

### 1. **跨平台与路径规范** ✅
- ✅ 统一相对路径：`D:\BIGBOSS\claudecode\.claude\...` → `.claude/...`
- ✅ 双平台命令示例：在CLAUDE.md中添加了PowerShell和Bash版本
- ✅ 跨平台Python调用：使用 `python -m pip`、`python -m venv`
- ✅ 任务脚本跨平台：添加了PowerShell版本说明

### 2. **多文件生成与自动化** ✅
- ✅ 触发词降噪：添加显式 `[MULTIFILE]`/`[BATCH]` 标记要求
- ✅ 校验与回滚：增加文件路径验证和命名规范检查
- ✅ 安全验证：防止覆盖关键文件的保护机制

### 3. **任务统计与成本追踪** ✅
- ✅ 相对路径与缓存目录：创建 `results/task_stats/` 标准化目录
- ✅ 统一输出格式：建立JSON schema (tokens, duration, cost_breakdown, steps, errors)
- ✅ 平台适配：文档中明确了PowerShell版本支持

### 4. **智能回测命令映射** ✅
- ✅ 数据路径验证：添加CSV存在性检查和下载指令生成
- ✅ 参数边界与预设：leverage (1-20), risk_pct (0-0.5), 安全上限
- ✅ 组合短语拓展：safe mode, high/low frequency, parameter sweep等
- ✅ 干跑模式：添加 `--dry-run` 支持建议

### 5. **数据与安全** ✅
- ✅ `.env.example`：创建了完整的环境变量模板
- ✅ 数据健康检查：强化 `data_health_check.py` 使用说明
- ✅ Git规范：明确不提交大型CSV/ZIP与OS专属路径的规则

### 6. **代码规范与测试** ✅
- ✅ 类型与安全：强调类型注解与 `utils/safe_math.py` 使用
- ✅ 安全数学：防除零与NaN/inf扩散的标准化要求
- ✅ 一致的参数入口：argparse注册与默认值一致性要求

### 7. **文档与可用性** ✅
- ✅ 跨平台命令矩阵：Windows PowerShell与Linux/WSL/Bash示例
- ✅ 故障排查：新增数据安全和验证部分
- ✅ 规范统一：建立了统一的安全和验证标准

### 8. **结果与可视化的一致性** ✅
- ✅ 结果列规范：建立了task_stats目录和JSON输出标准
- ✅ 元数据标准：为plots/*.meta.json约定schema要求  
- ✅ 版本标记：要求输出文件名包含版本与git hash

---

## 实施总结

采纳以上适配后，ChatGPT 在本仓库中现已实现：
- ✅ **更稳定地产生可落地改动**（标准化路径和命令）
- ✅ **跨平台与沙箱限制下保持一致性**（双平台命令支持）
- ✅ **输出与文档/结果格式严格对齐**（JSON标准化和安全规范）
- ✅ **"命令建议"与"安全约束"分离**（参数边界和验证机制）

**优化完成日期**: 2025年8月19日  
**实施状态**: 全部完成 ✅

