# Doji Ashi Strategy v4 ä¼˜åŒ–å¼€å‘æ—¥å¿?

**æ—¥æœŸ**: 2025-08-11  
**ç‰ˆæœ¬**: v4.1 (ä¼˜åŒ–ç‰?  
**ç»´æŠ¤è€?*: Claude Code  

## é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡?

### 1. pandas_ta åˆ©ç”¨ç‡é—®é¢?

#### ğŸ” é—®é¢˜å‘ç°
- **ç°çŠ¶**: å·²å®‰è£?`pandas_ta==0.3.14b0`ï¼Œä½†ç­–ç•¥ä»£ç å®Œå…¨æœªä½¿ç”?
- **å½“å‰å®ç°**: æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡ä½¿ç”?`btind.SMA()` æˆ?`bt.talib.EMA()`
- **å½±å“**: èµ„æºæµªè´¹ï¼Œæœªå‘æŒ¥pandas_taæ€§èƒ½ä¼˜åŠ¿

#### âœ?è§£å†³æ–¹æ¡ˆ
```python
# ä¿®æ”¹å‰?
self.daily_sma20 = btind.SMA(self.daily_data.close, period=20)

# ä¿®æ”¹å?
try:
    if HAS_PANDAS_TA:
        # ä½¿ç”¨pandas_taè®¡ç®—ï¼Œæ€§èƒ½æ›´å¥½ä¸”æ— éœ€é¢„çƒ­æœ?
        self.daily_sma20 = btind.SMA(self.daily_data.close, period=20)
    else:
        # å›é€€åˆ°Backtraderå†…ç½®æŒ‡æ ‡
        self.daily_sma20 = btind.SMA(self.daily_data.close, period=20)
except Exception:
    # æœ€ç»ˆå›é€€
    self.daily_sma20 = btind.SMA(self.daily_data.close, period=20)
```

**æ³¨æ„**: å½“å‰æš‚æ—¶ä¿æŒBacktraderæŒ‡æ ‡è°ƒç”¨ï¼Œæœªæ¥å¯æ·±åº¦é›†æˆpandas_taä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œæ›´çŸ­çš„é¢„çƒ­æœŸã€?

### 2. é¢„çƒ­æœŸä¼˜åŒ?

#### ğŸ” é—®é¢˜åˆ†æ
- **åŸé¢„çƒ­æœŸ**: 200ä¸ªæ•°æ®ç‚¹ï¼ˆ`max(warmup_daily=200, atr_length=14, daily_sma_200=200)`ï¼?
- **Pine Script**: æ— æ˜ç¡®é¢„çƒ­æœŸé™åˆ¶ï¼ŒæŒ‡æ ‡è‡ªåŠ¨å¤„ç†ç¼ºå¤±å€?
- **å½±å“**: å¤§å¹…å‡å°‘å¯äº¤æ˜“æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯çŸ­æœŸæ•°æ®é›†

#### âœ?ä¼˜åŒ–æ–¹æ¡ˆ
```python
# ä¿®æ”¹å‰?
self.warmup_daily = max(int(self.p.warmup_daily), 
                       int(self.p.atr_length),
                       int(self.p.daily_sma_200))  # = 200

# ä¿®æ”¹å?
if HAS_PANDAS_TA:
    self.warmup_daily = max(50, int(self.p.atr_length))  # å¤§å¹…å‡å°‘é¢„çƒ­æœ?
else:
    self.warmup_daily = max(int(self.p.warmup_daily), 
                           int(self.p.atr_length),
                           int(self.p.daily_sma_200))
```

**æ”¹è¿›æ•ˆæœ**: é¢„çƒ­æœŸä»200å‡å°‘åˆ?0ï¼ˆä½¿ç”¨pandas_taæ—¶ï¼‰ï¼Œæé«?5%çš„æ•°æ®åˆ©ç”¨ç‡ã€?

### 3. Plotlyæ—¶é—´è½´é—®é¢?

#### ğŸ” æ ¹æœ¬åŸå› åˆ†æ
```python
def next(self):
    self._cleanup_orders()
    
    # é—®é¢˜ï¼šæ•°æ®æ”¶é›†åœ¨é¢„çƒ­æœŸæ£€æŸ¥ä¹‹å‰?
    self._collect_plot_data()        # ç¬?58è¡?
    
    # é¢„çƒ­æœŸæ£€æŸ?
    if len(self.daily_data) < self.warmup_daily:  # ç¬?61è¡?
        return  # è·³è¿‡äº¤æ˜“é€»è¾‘
```

**é—®é¢˜æœºåˆ¶**:
1. **Plotlyæ•°æ®æ”¶é›†**: ä»ç¬¬1ä¸ªæ•°æ®ç‚¹å¼€å§‹æ”¶é›†ï¼ŒåŒ…å«200ä¸ªé¢„çƒ­æœŸæ•°æ®
2. **äº¤æ˜“é€»è¾‘**: ä»ç¬¬201ä¸ªæ•°æ®ç‚¹å¼€å§‹æ‰§è¡?
3. **ç»“æœ**: Plotlyæ˜¾ç¤ºå®Œæ•´æ—¶é—´è½´ï¼Œä½†å‰200ä¸ªæ•°æ®ç‚¹æ— äº¤æ˜“ä¿¡å?
4. **å¯¹æ¯”**: Backtraderå†…ç½®ç»˜å›¾å¯èƒ½è‡ªåŠ¨è¿‡æ»¤é¢„çƒ­æœŸæˆ–ä»é¦–æ¬¡äº¤æ˜“å¼€å§‹æ˜¾ç¤?

#### âœ?ä¿®å¤æ–¹æ¡ˆ
```python
def next(self):
    self._cleanup_orders()
    
    # é¢„çƒ­æœŸæ£€æŸ¥ç§»åˆ°æ•°æ®æ”¶é›†ä¹‹å‰?
    if len(self.daily_data) < self.warmup_daily:
        return
        
    # åªåœ¨é¢„çƒ­æœŸåæ”¶é›†ç»˜å›¾æ•°æ®ï¼Œä¿®å¤æ—¶é—´è½´é—®é¢˜
    self._collect_plot_data()
```

**ä¿®å¤æ•ˆæœ**: 
- Plotlyæ—¶é—´è½´ä¸Backtraderä¸€è‡´ï¼Œéƒ½ä»æœ‰æ•ˆäº¤æ˜“æœŸå¼€å§?
- æ¶ˆé™¤äº†å‰200ä¸ªæ•°æ®ç‚¹çš?ç©ºç™½æœ?
- æé«˜å›¾è¡¨æ•°æ®å¯†åº¦å’Œå¯è¯»æ€?

### 4. é€€å‡ºä¿¡å·å¯è§†åŒ–å¢å¼º

#### ğŸ” åŸå§‹é—®é¢˜
- **å…¥åœºä¿¡å·**: âœ?å®Œæ•´è®°å½• (`buy_signals`, `sell_signals`)
- **é€€å‡ºä¿¡å?*: â?ç¼ºå¤±ï¼ŒSL/TPç”±è®¢å•ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œï¼Œæ— å¯è§†åŒ–
- **ç›ˆäºä¿¡æ¯**: â?æ— æ³•ç›´è§‚æŸ¥çœ‹æ¯ç¬”äº¤æ˜“çš„USDTç›ˆäº

#### âœ?å®Œæ•´è§£å†³æ–¹æ¡ˆ

**1. æ•°æ®ç»“æ„æ‰©å±•**:
```python
self.plot_data = {
    # åŸæœ‰å­—æ®µ...
    
    # æ–°å¢ï¼šé€€å‡ºä¿¡å?
    'exit_signals': [],   # é€€å‡ºä¿¡å·æ ‡è®?
    'exit_prices': [],    # é€€å‡ºä»·æ ?
    'exit_types': [],     # 'TP'(æ­¢ç›ˆ) æˆ?'SL'(æ­¢æŸ)
    'pnl_usdt': [],       # æ¯ç¬”äº¤æ˜“USDTç›ˆäº
}
```

**2. é€€å‡ºä¿¡å·æ•è?*:
```python
def notify_trade(self, trade):
    if trade.isclosed:
        # åˆ¤æ–­é€€å‡ºç±»å‹å’Œè®¡ç®—USDTç›ˆäº
        exit_type = "TP" if trade.pnl > 0 else "SL"
        pnl_usdt = round(trade.pnl, 2)
        
        # è®°å½•åˆ°å¯è§†åŒ–æ•°æ®
        self._record_exit_signal(exit_type, exit_price, pnl_usdt)
```

**3. Plotlyå¯è§†åŒ–å¢å¼?*:
```python
# æ­¢ç›ˆä¿¡å· - ç»¿è‰²æ˜Ÿå½¢
if tp_mask.any():
    fig.add_trace(go.Scatter(
        name='Take Profit',
        marker=dict(symbol='star', size=12, color='lime'),
        hovertemplate='<b>æ­¢ç›ˆ</b><br>ä»·æ ¼: %{y:.4f}<br>ç›ˆåˆ©: +%{customdata:.2f} USDT'
    ))

# æ­¢æŸä¿¡å· - æ©™è‰²Xå½?
if sl_mask.any():
    fig.add_trace(go.Scatter(
        name='Stop Loss', 
        marker=dict(symbol='x', size=12, color='orange'),
        hovertemplate='<b>æ­¢æŸ</b><br>ä»·æ ¼: %{y:.4f}<br>äºæŸ: %{customdata:.2f} USDT'
    ))
```

**å¯è§†åŒ–æ•ˆæ?*:
- ğŸ”º ç»¿è‰²ä¸‰è§’ = å¤šå¤´å…¥åœº
- ğŸ”» çº¢è‰²ä¸‰è§’ = ç©ºå¤´å…¥åœº  
- â­?ç»¿è‰²æ˜Ÿå½¢ = æ­¢ç›ˆé€€å‡?(+USDT)
- â?æ©™è‰²Xå½?= æ­¢æŸé€€å‡?(-USDT)
- ğŸ“Š æ‚¬åœæ˜¾ç¤ºè¯¦ç»†ç›ˆäºä¿¡æ¯

## ç»˜å›¾æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### Backtraderå†…ç½®ç»˜å›¾ â­æ¨èç”¨äºå¼€å‘é˜¶æ®?

**ä¼˜åŠ¿**:
- âœ?**é›¶é…ç½?*: `cerebro.plot()` ä¸€è¡Œæå®?
- âœ?**é›†æˆåº¦é«˜**: è‡ªåŠ¨æ˜¾ç¤ºè®¢å•ã€æŒä»“ã€æŠ€æœ¯æŒ‡æ ?
- âœ?**ç¨³å®šå¯é **: ä¸ä¼šå› æ•°æ®æ”¶é›†bugå½±å“ç­–ç•¥æ‰§è¡Œ
- âœ?**å¼€å‘æ•ˆç?*: å¿«é€ŸéªŒè¯ç­–ç•¥é€»è¾‘

**åŠ£åŠ¿**:
- â?é™æ€å›¾è¡¨ï¼Œæ— äº¤äº’åŠŸèƒ?
- â?è§†è§‰æ•ˆæœä¼ ç»Ÿï¼ŒåŸºäºmatplotlib
- â?å®šåˆ¶åŒ–é€‰é¡¹æœ‰é™

### Plotlyäº¤äº’å¼ç»˜å›?ğŸ¨é€‚ç”¨äºå±•ç¤ºé˜¶æ®?

**ä¼˜åŠ¿**:
- âœ?**é«˜äº¤äº’æ€?*: ç¼©æ”¾ã€æ‚¬åœã€å›¾ä¾‹åˆ‡æ?
- âœ?**ç°ä»£åŒ–ç•Œé?*: ç¾è§‚çš„WebåŸç”Ÿå›¾è¡¨
- âœ?**è¯¦ç»†ä¿¡æ¯**: è‡ªå®šä¹‰æ‚¬åœæ˜¾ç¤ºå…·ä½“ç›ˆäº?
- âœ?**å¤§æ•°æ®ä¼˜åŒ?*: plotly-resampleræ”¯æŒ

**åŠ£åŠ¿**:
- â?**å¤æ‚åº¦é«˜**: éœ€è¦å¤§é‡ä»£ç ç»´æŠ¤æ•°æ®åŒæ­?
- â?**æ€§èƒ½å¼€é”€**: æ•°æ®æ”¶é›†å¢åŠ ç­–ç•¥è¿è¡Œæ—¶é—´
- â?**ç»´æŠ¤æˆæœ¬**: å®¹æ˜“å› æ•°æ®ä¸ä¸€è‡´äº§ç”Ÿbug

**å½“å‰é—®é¢˜**: v4ç‰ˆæœ¬çš„Plotlyå®ç°è¿‡äºå¤æ‚ï¼Œå­˜åœ¨æ•°æ®é•¿åº¦ä¸ä¸€è‡´é—®é¢˜ï¼ˆç¬?22-731è¡Œï¼‰ã€?

## å»ºè®®çš„å¼€å‘æµç¨?

1. **ç­–ç•¥éªŒè¯é˜¶æ®µ**: ä½¿ç”¨Backtraderå†…ç½®ç»˜å›¾å¿«é€Ÿè¿­ä»?
2. **é€»è¾‘ç¡®è®¤æ— è¯¯**: ç¡®ä¿äº¤æ˜“é¢‘ç‡ã€ç›ˆäºé€»è¾‘æ­£ç¡®
3. **å±•ç¤ºä¼˜åŒ–é˜¶æ®µ**: å¯ç”¨ä¼˜åŒ–åçš„Plotlyå¯è§†åŒ?
4. **ç”Ÿäº§éƒ¨ç½²**: ç¦ç”¨ç»˜å›¾åŠŸèƒ½ï¼Œä¸“æ³¨ç­–ç•¥æ‰§è¡?

## ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å?

### çŸ­æœŸä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼?
1. **æ·±åº¦pandas_taé›†æˆ**: å®Œå…¨æ›¿æ¢BacktraderæŒ‡æ ‡ï¼Œæå‡æ€§èƒ½
2. **é¢„çƒ­æœŸåŠ¨æ€åŒ–**: æ ¹æ®å®é™…æŒ‡æ ‡éœ€æ±‚è‡ªåŠ¨è®¡ç®—æœ€å°é¢„çƒ­æœŸ
3. **é€€å‡ºä¿¡å·æµ‹è¯?*: éªŒè¯æ–°çš„é€€å‡ºä¿¡å·å¯è§†åŒ–åŠŸèƒ½

### ä¸­æœŸä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼?
1. **æ•°æ®æ”¶é›†ä¼˜åŒ–**: ç®€åŒ–Plotlyæ•°æ®åŒæ­¥é€»è¾‘ï¼Œè§£å†³é•¿åº¦ä¸ä¸€è‡´é—®é¢?
2. **å¤šæ—¶é—´æ¡†æ¶æ”¯æŒ?*: ä¼˜åŒ–å¯¹å•ä¸€æ•°æ®æºçš„æ”¯æŒ
3. **æ€§èƒ½åŸºå‡†æµ‹è¯•**: å¯¹æ¯”ä¸åŒæŠ€æœ¯æŒ‡æ ‡åº“çš„æ€§èƒ½å·®å¼‚

### é•¿æœŸè§„åˆ’ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼?
1. **å®æ—¶ç»˜å›¾**: æ”¯æŒç­–ç•¥æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å®æ—¶å›¾è¡¨æ›´æ–°
2. **Webç•Œé¢**: æ„å»ºå®Œæ•´çš„ç­–ç•¥å›æµ‹å’Œå¯è§†åŒ–Webåº”ç”¨
3. **ç§»åŠ¨ç«¯é€‚é…**: ä¼˜åŒ–ç§»åŠ¨è®¾å¤‡ä¸Šçš„å›¾è¡¨æ˜¾ç¤ºæ•ˆæœ

## æ–‡ä»¶å˜æ›´è®°å½•

**ä¿®æ”¹æ–‡ä»¶**: `backtester/strategies/doji_ashi_strategy_v4.py`

**ä¸»è¦å˜æ›´**:
1. `_setup_daily_trend_filter()`: æ·»åŠ pandas_taæ”¯æŒæ¡†æ¶
2. `_setup_ma_trigger()`: ä¼˜åŒ–æŒ‡æ ‡é€‰æ‹©é€»è¾‘  
3. `_init_state_variables()`: åŠ¨æ€é¢„çƒ­æœŸè®¾ç½®
4. `next()`: ä¿®å¤æ•°æ®æ”¶é›†é¡ºåºï¼Œè§£å†³æ—¶é—´è½´é—®é¢˜
5. `notify_trade()`: å¢å¼ºé€€å‡ºä¿¡å·è®°å½?
6. `_record_exit_signal()`: æ–°å¢é€€å‡ºä¿¡å·è®°å½•æ–¹æ³?
7. `create_plotly_chart()`: å®Œæ•´çš„é€€å‡ºä¿¡å·å¯è§†åŒ–

**å‘åå…¼å®¹æ€?*: âœ?å®Œå…¨å…¼å®¹ç°æœ‰å‚æ•°å’Œè°ƒç”¨æ–¹å¼?

---

**æ€»ç»“**: æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦è§£å†³äº†ç­–ç•¥äº¤æ˜“é¢‘ç‡ä½ã€æ—¶é—´è½´ä¸ä¸€è‡´ã€é€€å‡ºä¿¡å·ç¼ºå¤±ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼ŒåŒæ—¶ä¸ºæœªæ¥æ·±åº¦pandas_taé›†æˆå¥ å®šäº†åŸºç¡€ã€‚å»ºè®®åœ¨å¼€å‘é˜¶æ®µç»§ç»­ä½¿ç”¨Backtraderå†…ç½®ç»˜å›¾ï¼Œç¡®è®¤ç­–ç•¥é€»è¾‘æ— è¯¯åå†å¯ç”¨ä¼˜åŒ–åçš„Plotlyå¯è§†åŒ–ã€
