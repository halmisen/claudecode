# 四剑客波段策略开发文档 v1.0
## RSI Smooth + SQZMOM + ATR + Divergence High Win Rate Swing Strategy

**项目代号**: Four Swords Swing Strategy v1.0  
**目标用户**: INFP性格交易者，500USDT小资金  
**开发目标**: 胜率75%+，月收益10-15%  
**开发标准**: 严格遵循 `docs/pine-script-standards.md`

---

## 🎯 策略核心设计

### 四大核心组件

**1. RSI Cyclic Smoothed (时机识别)**
- **功能**: 识别超买超卖的高质量时机
- **优势**: 平滑处理减少噪音，周期分析提高精度
- **阈值**: 超卖<30，超买>70
- **数据来源**: `pinescript/indicators/oscillator/RSI_Cyclic_Smoothed_v6.pine`

**2. SQZMOM WaveTrend (动量确认)**  
- **功能**: 确认突破的真实性和力度
- **优势**: 压缩释放捕捉爆发性行情
- **触发条件**: 压缩状态释放 + WaveTrend方向确认
- **数据来源**: `pinescript/indicators/oscillator/SQZMOM_WaveTrend.pine`

**3. ATR Dynamic Stop (风险管理)**
- **功能**: 根据市场波动率动态调整止损止盈
- **优势**: 避免固定止损的弱点，适应市场变化
- **倍数**: 止损1.5-2.5x ATR，止盈2-3x ATR
- **数据来源**: `pinescript/indicators/risk/ATR_Stop_Loss_Finder.pine`

**4. RSI Divergence (质量增强)**
- **功能**: 在关键位置通过背离增加信号确信度
- **优势**: 主图直接显示，提升决策效率
- **类型**: 常规背离(反转信号) + 隐藏背离(延续信号)
- **逻辑参考**: `pinescript/indicators/structure/Divergence_Any_Oscillator.pine`

---

## 🏗️ 技术架构设计

### 信号生成层次

**Level 0: 市场状态检测**
```pinescript
// 基础市场环境评估
bool_marketTrending = // 趋势环境判断
bool_marketRanging = // 震荡环境判断
float_volatilityLevel = // 波动率水平
```

**Level 1: 基础信号识别**
```pinescript  
// RSI超买超卖识别
bool_rsiOversold = float_rsiSmooth < 30.0
bool_rsiOverbought = float_rsiSmooth > 70.0

// SQZMOM压缩释放检测
bool_sqzRelease = // 压缩释放逻辑
bool_sqzDirection = // 释放方向确认
```

**Level 2: 质量确认层**
```pinescript
// RSI背离检测
bool_rsiBullDivergence = // 看涨背离
bool_rsiBearDivergence = // 看跌背离

// 成交量确认 
bool_volumeConfirm = volume > ta.sma(volume, 20) * 1.2
```

**Level 3: 信号评分系统**
```pinescript
int_signalStrength = 0
int_signalStrength += bool_rsiOversold ? 2 : 0        // RSI超卖 +2分
int_signalStrength += bool_sqzRelease ? 2 : 0         // 压缩释放 +2分  
int_signalStrength += bool_rsiBullDivergence ? 3 : 0  // 看涨背离 +3分
int_signalStrength += bool_volumeConfirm ? 1 : 0      // 成交量 +1分

// 高质量信号阈值 (≥5分入场)
bool_highQualityLong = int_signalStrength >= 5 and bool_rsiOversold
bool_highQualityShort = int_signalStrength >= 5 and bool_rsiOverbought
```

---

## 💻 Pine Script实现规范

### 变量命名规范
```pinescript
// RSI模块
float_rsiSmooth = // 平滑RSI值
int_rsiLength = // RSI周期
float_rsiFactor = // 平滑因子

// SQZMOM模块  
bool_sqzOn = // 压缩状态开启
bool_sqzOff = // 压缩状态结束
float_sqzMomentum = // 压缩动量值

// ATR模块
float_atrValue = // ATR值
float_atrStopLoss = // ATR止损位
float_atrTakeProfit = // ATR止盈位

// 背离模块
bool_rsiPivotLow = // RSI低点
bool_rsiPivotHigh = // RSI高点  
bool_priceDivergence = // 价格背离条件
```

### 函数设计规范
```pinescript
// 输入验证函数
validateRSIInput(float_input) => 
    not na(float_input) and float_input >= 0.0 and float_input <= 100.0

// 背离检测函数
detectBullishDivergence(float_oscValue, float_priceValue, int_lookback) =>
    bool_oscHL = float_oscValue > float_oscValue[int_lookback] 
    bool_priceLL = float_priceValue < float_priceValue[int_lookback]
    bool_oscHL and bool_priceLL

// 信号强度计算
calculateSignalStrength(bool_rsi, bool_sqz, bool_div, bool_vol) =>
    int_strength = 0
    int_strength += bool_rsi ? 2 : 0
    int_strength += bool_sqz ? 2 : 0
    int_strength += bool_div ? 3 : 0
    int_strength += bool_vol ? 1 : 0
    int_strength

// ATR动态计算  
calculateDynamicATR(float_atr, float_volatilityAdj) =>
    float_adjustedATR = float_atr * float_volatilityAdj
    float_stopLoss = close - (float_adjustedATR * 2.0)
    float_takeProfit = close + (float_adjustedATR * 2.5) 
    [float_stopLoss, float_takeProfit]
```

---

## 📊 策略逻辑流程

### 入场逻辑
```
1. 市场状态检查 → 确认适合波段交易环境
2. RSI区间确认 → 超买/超卖区间
3. SQZMOM状态 → 压缩释放确认
4. 背离检测 → RSI与价格背离
5. 成交量验证 → 突破真实性
6. 信号评分 → ≥5分触发入场
7. ATR计算 → 动态止损止盈设定
```

### 出场逻辑
```
Priority 1: 止损触发 (ATR动态止损)
Priority 2: 止盈触发 (ATR动态止盈)  
Priority 3: RSI反转 (进入相反极值区)
Priority 4: SQZMOM反向 (动量反转)
Priority 5: 时间止损 (最长持仓3-5天)
```

### 风险管理
```
单笔风险: 1-2% (基于500USDT = 5-10USDT)
最大仓位: 20-25%  
连亏保护: 连续3次止损暂停1天
盈利保护: 盈利>10%后50%减仓
资金管理: Kelly公式优化仓位
```

---

## 🎨 主图可视化设计

### 信号标记系统
```pinescript
// 入场信号
plotshape(bool_highQualityLong, "Long Signal", shape.triangleup, location.belowbar, 
          color.new(color.green, 0), size=size.normal)
plotshape(bool_highQualityShort, "Short Signal", shape.triangledown, location.abovebar,
          color.new(color.red, 0), size=size.normal)

// 背离标记  
plotshape(bool_rsiBullDivergence, "Bull Divergence", shape.circle, location.belowbar,
          color.new(color.lime, 30), size=size.small)
plotshape(bool_rsiBearDivergence, "Bear Divergence", shape.circle, location.abovebar,
          color.new(color.orange, 30), size=size.small)

// 止损止盈线
plot(float_atrStopLoss, "Dynamic Stop", color.red, 2, plot.style_stepline)
plot(float_atrTakeProfit, "Dynamic Target", color.green, 2, plot.style_stepline)
```

### 信息面板设计
```pinescript
// 实时状态显示
if barstate.islast
    var label label_info = label.new(na, na, "", style=label.style_label_left, 
                                    color=color.new(color.white, 10), textcolor=color.black)
    label.set_xy(label_info, bar_index + 3, high)
    
    string_rsiStatus = "RSI: " + str.tostring(float_rsiSmooth, "#.##")
    string_sqzStatus = "SQZ: " + (bool_sqzOn ? "ON" : "OFF") 
    string_signalStrength = "Signal: " + str.tostring(int_signalStrength) + "/8"
    string_divStatus = "Div: " + (bool_rsiBullDivergence ? "BULL" : bool_rsiBearDivergence ? "BEAR" : "NONE")
    
    label.set_text(label_info, "Four Swords v1.0\n" + string_rsiStatus + "\n" + 
                   string_sqzStatus + "\n" + string_signalStrength + "\n" + string_divStatus)
```

---

## 🔬 回测验证计划

### 数据要求
- **时间框架**: 4H主图 (适合波段交易)  
- **测试周期**: 2022-2024年 (包含多种市场环境)
- **测试标的**: BTC/USDT, ETH/USDT, SOL/USDT
- **手续费**: 0.02% (接近实际交易成本)

### 验证指标
```
目标指标:
- 胜率: >75%
- 夏普比率: >1.2  
- 最大回撤: <12%
- 盈利因子: >2.0
- 月收益: 8-15%

风险指标:
- 最大连续亏损: <4次
- 95% VaR: <3%
- Calmar比率: >1.5
```

### 压力测试
- **极端行情**: 2022年5月Terra崩盘
- **震荡行情**: 2023年横盘整理期  
- **单边行情**: 2024年BTC突破新高
- **高波动期**: 各种黑天鹅事件

---

## 📈 开发里程碑

### Phase 1: 核心框架 (Week 1-2)
- [ ] 基础策略架构搭建
- [ ] RSI平滑计算实现  
- [ ] SQZMOM压缩检测逻辑
- [ ] 基础信号生成系统

### Phase 2: 背离增强 (Week 3)  
- [ ] RSI背离检测算法
- [ ] 主图背离标记显示
- [ ] 信号评分系统集成
- [ ] 初步回测验证

### Phase 3: 风险管理 (Week 4)
- [ ] ATR动态止损实现
- [ ] 多层级出场逻辑  
- [ ] 资金管理系统
- [ ] 完整回测报告

### Phase 4: 优化完善 (Week 5-6)
- [ ] 参数敏感性分析
- [ ] 不同市场环境测试
- [ ] 用户界面优化
- [ ] 实盘前最终验证

---

## 🎯 成功标准

### 技术指标
- 胜率稳定在75%以上
- 月收益10-15%，年化120-200%
- 最大回撤控制在12%以内  
- 连续亏损不超过4次

### 用户体验  
- INFP性格友好，减少心理压力
- 信号清晰明确，减少主观判断
- 可视化直观，便于快速决策
- 自动化程度高，减少操作失误

### 风险控制
- 单笔风险严格控制在1-2%
- 总体风险可控，适合小资金  
- 回撤期间快速恢复能力
- 黑天鹅事件防护机制

---

**开发理念**: 
- 🎯 **高胜率优先** - INFP心理兼容性第一
- 📊 **数据驱动** - 基于真实回测优化参数  
- 🛡️ **风险第一** - 保本前提下追求收益
- 🔄 **持续改进** - 根据实战表现不断迭代