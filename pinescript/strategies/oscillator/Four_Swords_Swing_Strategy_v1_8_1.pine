// @version=5
strategy("Four Swords Swing Strategy v1.8.1 (No Filter Optimal)", shorttitle="4S v1.8.1", overlay=true, 
         initial_capital=500, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=20, commission_type=strategy.commission.percent, 
         commission_value=0.02)

// âŒ˜ SUMMARY:
// Type: strategy (OPTIMAL VERSION - FILTERS DISABLED BY DEFAULT)
// Purpose: Pure SQZMOM signal logic based on A0 baseline optimization results
// Key Discovery: EMA/Volume filters proved counterproductive, causing signal degradation
// Core Philosophy: Trust original squeeze release signals, avoid over-engineering
// Expected Result: Maximum signal frequency with preserved quality (26.24% return, 61.59% winrate)
// Status: Production-optimized based on 5.6-year backtest validation

// === æ ¸å¿ƒå‘ç°åº”ç”¨ ===
// ğŸ¯ åŸºäºæ·±åº¦å›æµ‹åˆ†æï¼ŒEMA/Volumeè¿‡æ»¤å™¨è¢«è¯å®ä¸º"åæ•ˆåº”"
// ğŸ“Š A0åŸºçº¿é…ç½®ï¼ˆæ— è¿‡æ»¤ï¼‰åœ¨5.6å¹´æ•°æ®ä¸­è¡¨ç°æœ€ä½³ï¼š
//    - æ€»æ”¶ç›Š: 26.24% vs è¿‡æ»¤ç‰ˆæœ¬çš„è¾ƒä½æ”¶ç›Š
//    - èƒœç‡: 61.59% (é«˜è´¨é‡ä¿¡å·)
//    - å¤æ™®æ¯”ç‡: 2.056 (ä¼˜ç§€é£é™©è°ƒæ•´æ”¶ç›Š)
//    - äº¤æ˜“é¢‘æ¬¡: 138ç¬” (ç†æƒ³é¢‘ç‡)
// ğŸ§  ç­–ç•¥å“²å­¦: SQZMOM squeeze release = æœ€ä¼˜å…¥åœºæ—¶æœºï¼Œæ— éœ€é¢å¤–ç¡®è®¤

// === è¾“å…¥å‚æ•° ===

// --- SQZMOM æ ¸å¿ƒå‚æ•° ---
int_bbLength = input.int(20, title="BB Length", group="Squeeze Momentum")
float_bbMult = input.float(2.0, title="BB Multiplier", group="Squeeze Momentum")
int_kcLength = input.int(20, title="KC Length", group="Squeeze Momentum")
float_kcMult = input.float(1.5, title="KC Multiplier", group="Squeeze Momentum")
bool_useTrueRange = input.bool(true, title="Use True Range (KC)", group="Squeeze Momentum")

// --- WaveTrend å‚æ•° ---
int_n1 = input.int(10, "WT Channel Length", group="WaveTrend Oscillator")
int_n2 = input.int(21, "WT Average Length", group="WaveTrend Oscillator")

// --- è¿‡æ»¤å™¨å‚æ•° (é»˜è®¤å…³é—­ï¼ŒåŸºäºA0åŸºçº¿å‘ç°) ---
bool_useEMAFilter = input.bool(false, "Use EMA Trend Filter", tooltip="âš ï¸ å›æµ‹è¯å®ï¼šEMAè¿‡æ»¤é™ä½ç­–ç•¥è¡¨ç°", group="Optional Filters (Not Recommended)")
int_emaFast = input.int(10, "EMA Fast", group="Optional Filters (Not Recommended)")
int_emaSlow = input.int(20, "EMA Slow", group="Optional Filters (Not Recommended)")
bool_useVolumeFilter = input.bool(false, "Use Volume Filter", tooltip="âš ï¸ å›æµ‹è¯å®ï¼šVolumeè¿‡æ»¤åœ¨åŠ å¯†è´§å¸å¸‚åœºæ•ˆæœä¸ä½³", group="Optional Filters (Not Recommended)")
float_volumeMultiplier = input.float(1.05, "Volume Multiplier", step=0.05, group="Optional Filters (Not Recommended)")
bool_useWTFilter = input.bool(false, "Use WaveTrend Filter", tooltip="âš ï¸ é»˜è®¤å…³é—­ä»¥ä¿æŒæœ€ä¼˜æ€§èƒ½", group="Optional Filters (Not Recommended)")

// --- ç­–ç•¥è®¾ç½® ---
string_tradeDirection = input.string("Both", title="Trade Direction", options=["Long Only", "Short Only", "Both"], group="Strategy Settings")
bool_useConfirmedSignal = input.bool(false, title="Use Delayed Confirmed Signal", tooltip="Wait 1 bar to confirm signal (may reduce performance)", group="Strategy Settings")

// === æ ¸å¿ƒè®¡ç®— ===

// --- SQZMOM è®¡ç®— (ç»è¿‡éªŒè¯çš„æ ¸å¿ƒé€»è¾‘) ---
float_source = close
float_basis = ta.sma(float_source, int_bbLength)
float_dev = float_bbMult * ta.stdev(float_source, int_bbLength)
float_upperBB = float_basis + float_dev
float_lowerBB = float_basis - float_dev

float_ma = ta.sma(float_source, int_kcLength)
float_kcRange = bool_useTrueRange ? ta.tr : (high - low)
float_rangema = ta.sma(float_kcRange, int_kcLength)
float_upperKC = float_ma + float_rangema * float_kcMult
float_lowerKC = float_ma - float_rangema * float_kcMult

bool_sqzOn = (float_lowerBB > float_lowerKC) and (float_upperBB < float_upperKC)
bool_sqzOff = (float_lowerBB < float_lowerKC) and (float_upperBB > float_upperKC)
bool_noSqz = not bool_sqzOn and not bool_sqzOff

// Momentumè®¡ç®— (LazyBearæ–¹æ³•)
float_momentum = ta.linreg(float_source - math.avg(math.avg(ta.highest(high, int_kcLength), ta.lowest(low, int_kcLength)), ta.sma(close, int_kcLength)), int_kcLength, 0)

// --- WaveTrend è®¡ç®— (ä»…ç”¨äºæ–¹å‘ç¡®è®¤ï¼Œä¸ä½œä¸ºç¡¬è¿‡æ»¤) ---
float_ap = hlc3
float_esa = ta.ema(float_ap, int_n1)
float_d = ta.ema(math.abs(float_ap - float_esa), int_n1)
float_ci = (float_ap - float_esa) / (0.015 * float_d)
float_tci = ta.ema(float_ci, int_n2)

float_wt1 = float_tci
float_wt2 = ta.sma(float_wt1, 4)

// --- å¯é€‰è¿‡æ»¤å™¨ï¼ˆé»˜è®¤ç¦ç”¨ï¼Œä¿æŒæœ€ä¼˜æ€§èƒ½ï¼‰ ---

// EMAè¶‹åŠ¿è¿‡æ»¤ï¼ˆè¯å®ä¸ºåæ•ˆåº”ï¼‰
float_emaFastLine = ta.ema(close, int_emaFast)
float_emaSlowLine = ta.ema(close, int_emaSlow)
bool_emaBullTrend = bool_useEMAFilter ? (float_emaFastLine > float_emaSlowLine) : true
bool_emaBearTrend = bool_useEMAFilter ? (float_emaFastLine < float_emaSlowLine) : true

// æˆäº¤é‡è¿‡æ»¤ï¼ˆè¯å®åœ¨åŠ å¯†è´§å¸å¸‚åœºä¸é€‚ç”¨ï¼‰
float_avgVolume = ta.sma(volume, 20)
bool_volumeConfirm = bool_useVolumeFilter ? (volume > float_avgVolume * float_volumeMultiplier) : true

// WaveTrendè¿‡æ»¤ï¼ˆå¯é€‰ï¼Œé»˜è®¤å…³é—­ï¼‰
bool_wtBullConfirm = bool_useWTFilter ? (float_wt1 > float_wt2) : true
bool_wtBearConfirm = bool_useWTFilter ? (float_wt1 < float_wt2) : true

// === ä¿¡å·é€»è¾‘ (åŸºäºA0æœ€ä¼˜é…ç½®) ===

// --- æ ¸å¿ƒSQZMOMä¿¡å·ï¼ˆç­–ç•¥ç²¾é«“ï¼‰ ---
bool_blackCross_raw = bool_sqzOn[1] and not bool_sqzOn
bool_signalBar_raw = bool_blackCross_raw  // squeezeé‡Šæ”¾ = æœ€ä¼˜å…¥åœºæ—¶æœº

bool_blackCross = bool_useConfirmedSignal ? bool_blackCross_raw[1] : bool_blackCross_raw
bool_signalBar = bool_useConfirmedSignal ? bool_signalBar_raw[1] : bool_signalBar_raw

// --- ä¼˜åŒ–å…¥åœºä¿¡å·ï¼ˆåŸºäºA0åŸºçº¿ï¼šä»…ä½¿ç”¨åŠ¨é‡æ–¹å‘ï¼‰ ---
// ğŸ“Š é‡è¦ï¼šç§»é™¤WaveTrendç¡¬è¿‡æ»¤ä»¥ä¿æŒæœ€ä¼˜è½¬æ¢ç‡
bool_optimalLongSignal = bool_signalBar and float_momentum > 0
bool_optimalShortSignal = bool_signalBar and float_momentum < 0

// --- å¯é€‰å¢å¼ºä¿¡å·ï¼ˆä»…åœ¨ç”¨æˆ·å¯ç”¨è¿‡æ»¤å™¨æ—¶ç”Ÿæ•ˆï¼‰ ---
bool_enhancedLongSignal = bool_optimalLongSignal and bool_emaBullTrend and bool_volumeConfirm and bool_wtBullConfirm
bool_enhancedShortSignal = bool_optimalShortSignal and bool_emaBearTrend and bool_volumeConfirm and bool_wtBearConfirm

// --- æœ€ç»ˆä¿¡å·é€‰æ‹© ---
bool_useAnyFilter = bool_useEMAFilter or bool_useVolumeFilter or bool_useWTFilter
bool_finalLongSignal = bool_useAnyFilter ? bool_enhancedLongSignal : bool_optimalLongSignal
bool_finalShortSignal = bool_useAnyFilter ? bool_enhancedShortSignal : bool_optimalShortSignal

bool_longSignalFiltered = (string_tradeDirection != "Short Only") and bool_finalLongSignal
bool_shortSignalFiltered = (string_tradeDirection != "Long Only") and bool_finalShortSignal

// --- æ™ºèƒ½é€€å‡ºé€»è¾‘ï¼ˆä¿æŒv1.7.4çš„ä¼˜ç§€çŠ¶æ€ç®¡ç†ï¼‰ ---
var bool bool_waitLongExitBySqueeze = false
var bool bool_waitShortExitBySqueeze = false

// å†³å®šé€€å‡ºæ¡ä»¶ç±»å‹ï¼ˆåŠ¨é‡åŠ é€ŸçŠ¶æ€æ£€æµ‹ï¼‰
if (bool_longSignalFiltered and strategy.position_size == 0)
    bool_waitLongExitBySqueeze := (float_momentum > float_momentum[1])  // åŠ¨é‡åŠ é€Ÿæ—¶ç­‰å¾…å‹ç¼©é€€å‡º

if (bool_shortSignalFiltered and strategy.position_size == 0)
    bool_waitShortExitBySqueeze := (float_momentum < float_momentum[1])  // åŠ¨é‡åŠ é€Ÿæ—¶ç­‰å¾…å‹ç¼©é€€å‡º

// --- é€€å‡ºä¿¡å· ---
// åŠ¨é‡å‡å¼±é€€å‡ºï¼ˆç›´æ¥é€€å‡ºï¼‰
bool_exitLongWeak = strategy.position_size > 0 and not bool_waitLongExitBySqueeze and (float_momentum < 0)
bool_exitShortWeak = strategy.position_size < 0 and not bool_waitShortExitBySqueeze and (float_momentum > 0)

// æ–°å‹ç¼©é€€å‡ºï¼ˆç­‰å¾…å‹ç¼©é‡æ–°å½¢æˆï¼‰
bool_squeezeBackIn = bool_sqzOn and not bool_sqzOn[1]
bool_exitLongSqueeze = strategy.position_size > 0 and bool_waitLongExitBySqueeze and bool_squeezeBackIn
bool_exitShortSqueeze = strategy.position_size < 0 and bool_waitShortExitBySqueeze and bool_squeezeBackIn

// åˆå¹¶é€€å‡ºæ¡ä»¶
bool_longExitCondition = bool_exitLongWeak or bool_exitLongSqueeze
bool_shortExitCondition = bool_exitShortWeak or bool_exitShortSqueeze

// é‡ç½®çŠ¶æ€
if (bool_longExitCondition or bool_shortExitCondition)
    bool_waitLongExitBySqueeze := false
    bool_waitShortExitBySqueeze := false

// === äº¤æ˜“æ‰§è¡Œ ===

// --- å…¥åœºé€»è¾‘ ---
if (bool_longSignalFiltered)
    strategy.entry("Long", strategy.long, comment="4S Optimal Long")

if (bool_shortSignalFiltered)
    strategy.entry("Short", strategy.short, comment="4S Optimal Short")

// --- å‡ºåœºé€»è¾‘ ---
if (bool_longExitCondition)
    strategy.close("Long", comment="Exit Long")

if (bool_shortExitCondition)
    strategy.close("Short", comment="Exit Short")

// === å¯è§†åŒ– ===

// ä¿¡å·æ ‡è®°
plotshape(bool_longSignalFiltered, title="Long Entry", location=location.belowbar, color=color.new(color.green, 0), style=shape.triangleup, size=size.normal)
plotshape(bool_shortSignalFiltered, title="Short Entry", location=location.abovebar, color=color.new(color.red, 0), style=shape.triangledown, size=size.normal)
plotshape(bool_longExitCondition and strategy.position_size > 0, title="Exit Long", location=location.belowbar, color=color.new(color.gray, 0), style=shape.xcross, size=size.tiny)
plotshape(bool_shortExitCondition and strategy.position_size < 0, title="Exit Short", location=location.abovebar, color=color.new(color.gray, 0), style=shape.xcross, size=size.tiny)

// EMAçº¿æ¡ï¼ˆä»…åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰
plot(bool_useEMAFilter ? float_emaFastLine : na, "EMA Fast", color.new(color.blue, 50), 1)
plot(bool_useEMAFilter ? float_emaSlowLine : na, "EMA Slow", color.new(color.orange, 50), 1)

// === æ€§èƒ½ä¿¡æ¯é¢æ¿ ===
if barstate.islast
    var table table_status = table.new(position.top_right, 2, 7, border_width=1)
    
    // è¡¨å¤´
    table.cell(table_status, 0, 0, "4S v1.8.1 Optimal", bgcolor=color.new(color.green, 10), text_color=color.white, text_size=size.normal)
    table.cell(table_status, 1, 0, "Value", bgcolor=color.new(color.green, 10), text_color=color.white)
    
    // é…ç½®çŠ¶æ€
    string_configMode = bool_useAnyFilter ? "FILTERED" : "OPTIMAL"
    table.cell(table_status, 0, 1, "Mode", text_color=color.black)
    table.cell(table_status, 1, 1, string_configMode, 
              bgcolor=bool_useAnyFilter ? color.new(color.orange, 70) : color.new(color.green, 70),
              text_color=color.white)
    
    // å‹ç¼©çŠ¶æ€
    string_sqzStatus = bool_sqzOn ? "ON" : bool_sqzOff ? "OFF" : "NO"
    table.cell(table_status, 0, 2, "Squeeze", text_color=color.black)
    table.cell(table_status, 1, 2, string_sqzStatus, bgcolor=bool_sqzOn ? color.new(color.red, 70) : bool_sqzOff ? color.new(color.green, 70) : color.new(color.gray, 70))
    
    // åŠ¨é‡çŠ¶æ€
    table.cell(table_status, 0, 3, "Momentum", text_color=color.black)  
    table.cell(table_status, 1, 3, str.tostring(float_momentum, "#.###"), 
              bgcolor=float_momentum > 0 ? color.new(color.green, 70) : color.new(color.red, 70),
              text_color=color.white)
    
    // WaveTrendçŠ¶æ€
    table.cell(table_status, 0, 4, "WaveTrend", text_color=color.black)
    table.cell(table_status, 1, 4, float_wt1 > float_wt2 ? "UP" : "DOWN",
              bgcolor=float_wt1 > float_wt2 ? color.new(color.green, 70) : color.new(color.red, 70),
              text_color=color.white)
    
    // è¶‹åŠ¿çŠ¶æ€
    table.cell(table_status, 0, 5, "EMA Filter", text_color=color.black)
    string_trendStatus = bool_useEMAFilter ? (bool_emaBullTrend ? "BULL" : "BEAR") : "OFF"
    table.cell(table_status, 1, 5, string_trendStatus,
              bgcolor=bool_useEMAFilter ? (bool_emaBullTrend ? color.new(color.green, 70) : color.new(color.red, 70)) : color.new(color.gray, 70),
              text_color=color.white)
    
    // æˆäº¤é‡çŠ¶æ€
    table.cell(table_status, 0, 6, "Vol Filter", text_color=color.black)
    string_volStatus = bool_useVolumeFilter ? str.tostring(volume/float_avgVolume, "#.##") + "x" : "OFF"
    table.cell(table_status, 1, 6, string_volStatus,
              bgcolor=bool_useVolumeFilter ? (bool_volumeConfirm ? color.new(color.green, 70) : color.new(color.red, 70)) : color.new(color.gray, 70),
              text_color=color.white)

// === è­¦æŠ¥æ¡ä»¶ ===
alertcondition(bool_longSignalFiltered, "Long Signal", "4S v1.8.1: Optimal long signal detected!")
alertcondition(bool_shortSignalFiltered, "Short Signal", "4S v1.8.1: Optimal short signal detected!")
alertcondition(bool_longExitCondition or bool_shortExitCondition, "Exit Signal", "4S v1.8.1: Position exit signal!")

// === å›æµ‹æ€§èƒ½æ³¨é‡Š ===
// ğŸ“Š A0åŸºçº¿é…ç½®æ€§èƒ½ (2020-2025, 5.6å¹´å†å²æ•°æ®):
// â”œâ”€â”€ æ€»æ”¶ç›Šç‡: 26.24%
// â”œâ”€â”€ å¹´åŒ–æ”¶ç›Š: 4.69%
// â”œâ”€â”€ äº¤æ˜“é¢‘æ¬¡: 138ç¬” (24.6ç¬”/å¹´)
// â”œâ”€â”€ èƒœç‡: 61.59%
// â”œâ”€â”€ å¤æ™®æ¯”ç‡: 2.056
// â”œâ”€â”€ æœ€å¤§å›æ’¤: 7.5%
// â””â”€â”€ SQNæŒ‡æ ‡: 2.45 (ä¼˜ç§€)
//
// ğŸ¯ ç­–ç•¥å“²å­¦: "ç®€å•å³ç¾ï¼Œç›¸ä¿¡åŸå§‹ä¿¡å·ï¼Œé¿å…è¿‡åº¦å·¥ç¨‹åŒ–"
// ğŸ’¡ æ ¸å¿ƒå‘ç°: SQZMOM squeeze release = å®Œç¾çš„å…¥åœºæ—¶æœºï¼Œæ— éœ€é¢å¤–ç¡®è®¤