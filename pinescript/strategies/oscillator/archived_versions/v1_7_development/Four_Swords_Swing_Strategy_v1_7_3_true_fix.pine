// @version=5
strategy("Four Swords Swing Strategy v1.7.3 True Fix", shorttitle="4S v1.7.3", overlay=true, 
         initial_capital=500, default_qty_type=strategy.percent_of_equity, 
         default_qty_value=15, commission_type=strategy.commission.percent, 
         commission_value=0.02, calc_on_every_tick=false)

// âŒ˜ SUMMARY:
// Type: strategy (TRUE FIX - BACK TO v1.5 SIGNAL LOGIC + ENHANCEMENTS)
// Purpose: Restore v1.5 signal frequency by using direct squeeze release detection
// Key Fix: Removed Release Window constraints, using v1.5 immediate signal detection
// Critical Changes: v1.5 parameters (BB:20/2.0, KC:20/1.5, WT:21), direct signalBar detection
// Expected Result: Signal frequency should match or exceed v1.5 performance
// Logic: v1.5 proven signal detection + optional Release Window visuals
// Status: Production-ready with verified v1.5 signal generation mechanism

// === è¾“å…¥å‚æ•° ===

// --- ğŸš€ Release Window System (NEW!) ---
group_window = "ğŸš€ Release Window System"
int_releaseWindow = input.int(5, title="Release Window Size", minval=3, maxval=10, tooltip="Number of bars after squeeze release to allow signal detection. Higher = more opportunities, Lower = stricter timing", group=group_window)
bool_showWindowVisuals = input.bool(true, title="Show Window Visuals", tooltip="Display window background, countdown labels, and release markers", group=group_window)
bool_preventDuplicates = input.bool(false, title="Prevent Duplicate Signals", tooltip="Only allow one signal per release window (RECOMMENDED: OFF for max frequency)", group=group_window)

// --- ä¿¡å·æ¨¡å¼é€‰æ‹© ---
group_mode = "Signal Mode"
string_signalMode = input.string("Balanced", title="Signal Mode", options=["Strict", "Balanced", "Aggressive", "Ultra"], tooltip="Strict: Core+EMA+Volume, Balanced: Core+(EMA OR Volume), Aggressive: Core only, Ultra: Window+Momentum only", group=group_mode)
bool_useSimplifiedSignals = input.bool(false, title="Enable Ultra Simplified Signals", tooltip="Even more frequent signals - Window+Momentum only, bypasses WaveTrend", group=group_mode)

// --- SQZMOM ä¼˜åŒ–å‚æ•° ---
group_sqzmom = "Squeeze Momentum (Optimized)"
int_bbLength = input.int(20, title="BB Length", minval=10, maxval=25, group=group_sqzmom)
float_bbMult = input.float(2.0, title="BB Multiplier", minval=1.5, maxval=2.5, step=0.1, group=group_sqzmom)
int_kcLength = input.int(20, title="KC Length", minval=10, maxval=25, group=group_sqzmom)
float_kcMult = input.float(1.5, title="KC Multiplier", minval=1.0, maxval=2.0, step=0.1, group=group_sqzmom)
bool_useTrueRange = input.bool(true, title="Use True Range (KC)", group=group_sqzmom)

// --- WaveTrend ä¼˜åŒ–å‚æ•° ---
group_wavetrend = "WaveTrend Filter"
int_n1 = input.int(10, "WT Channel Length", minval=8, maxval=15, group=group_wavetrend)
int_n2 = input.int(21, "WT Average Length", minval=15, maxval=25, group=group_wavetrend)
int_wtSmooth = input.int(3, "WT Smoothing", minval=2, maxval=5, group=group_wavetrend)

// --- ç®€åŒ–è¿‡æ»¤ç³»ç»Ÿ ---
group_filters = "Simple Filters"
bool_useEMAFilter = input.bool(true, "Use EMA Trend Filter", group=group_filters)
int_emaFast = input.int(20, "EMA Fast", minval=15, maxval=30, group=group_filters)
int_emaSlow = input.int(50, "EMA Slow", minval=40, maxval=60, group=group_filters)
bool_useVolumeFilter = input.bool(true, "Use Volume Filter", group=group_filters)
float_volumeMultiplier = input.float(1.1, "Volume Multiplier", minval=1.0, maxval=2.0, step=0.1, group=group_filters)

// --- é£é™©ç®¡ç† ---
group_risk = "Risk Management"
bool_useStopLoss = input.bool(true, "Enable Stop Loss", group=group_risk)
float_atrMultiplier = input.float(2.0, "ATR Stop Multiplier", minval=1.5, maxval=3.0, step=0.1, group=group_risk)
int_atrLength = input.int(14, "ATR Length", minval=10, maxval=20, group=group_risk)
bool_useVolatilityPosition = input.bool(true, "Volatility-Adjusted Sizing", group=group_risk)
float_basePositionSize = input.float(15.0, "Base Position Size %", minval=10.0, maxval=25.0, step=1.0, group=group_risk)

// --- è°ƒè¯•è®¾ç½® ---
group_debug = "Debug Settings"
bool_showAllSignals = input.bool(true, "Show All Signal Layers", group=group_debug)
bool_showStatusPanel = input.bool(true, "Show Enhanced Status Panel", group=group_debug)
bool_showWindowStats = input.bool(true, "Show Window Statistics", group=group_debug)

// --- ç­–ç•¥è®¾ç½® ---
group_strategy = "Strategy Settings"
string_tradeDirection = input.string("Both", title="Trade Direction", options=["Long Only", "Short Only", "Both"], group=group_strategy)

// === ğŸš€ RELEASE WINDOW STATE TRACKING (CORE INNOVATION) ===

// Window state variables
var int int_windowCountdown = 0
var bool bool_inReleaseWindow = false
var bool bool_windowSignalTriggered = false
var int int_windowStartBar = 0

// Statistics tracking
var int int_totalWindows = 0
var int int_totalWindowSignals = 0

// === æ ¸å¿ƒè®¡ç®— ===

// --- Market Regime Detection (ç®€åŒ–ç‰ˆ) ---
float_atr14 = ta.atr(14)
float_atr50sma = ta.sma(float_atr14, 50)
float_atrRatio = float_atr14 / float_atr50sma
bool_volatileMarket = float_atrRatio > 1.15

// --- SQZMOM è®¡ç®— ---
float_source = close
float_basis = ta.sma(float_source, int_bbLength)
float_dev = float_bbMult * ta.stdev(float_source, int_bbLength)
float_upperBB = float_basis + float_dev
float_lowerBB = float_basis - float_dev

float_ma = ta.sma(float_source, int_kcLength)
float_kcRange = bool_useTrueRange ? ta.tr : (high - low)
float_rangema = ta.sma(float_kcRange, int_kcLength)
float_upperKC = float_ma + float_rangema * float_kcMult
float_lowerKC = float_ma - float_rangema * float_kcMult

bool_sqzOn = (float_lowerBB > float_lowerKC) and (float_upperBB < float_upperKC)
bool_sqzOff = (float_lowerBB < float_lowerKC) and (float_upperBB > float_upperKC)
bool_noSqz = not bool_sqzOn and not bool_sqzOff

// Momentumè®¡ç®—
float_momentum = ta.linreg(float_source - math.avg(math.avg(ta.highest(high, int_kcLength), ta.lowest(low, int_kcLength)), ta.sma(close, int_kcLength)), int_kcLength, 0)

// --- WaveTrend è®¡ç®— ---
float_ap = hlc3
float_esa = ta.ema(float_ap, int_n1)
float_d = ta.ema(math.abs(float_ap - float_esa), int_n1)
float_ci = float_d != 0 ? (float_ap - float_esa) / (0.015 * float_d) : 0
float_tci = ta.ema(float_ci, int_n2)

float_wt1 = float_tci
float_wt2 = ta.sma(float_wt1, int_wtSmooth)

// --- è¿‡æ»¤å™¨è®¡ç®— ---
float_emaFastLine = ta.ema(close, int_emaFast)
float_emaSlowLine = ta.ema(close, int_emaSlow)
bool_emaBullTrend = bool_useEMAFilter ? (float_emaFastLine > float_emaSlowLine) : true
bool_emaBearTrend = bool_useEMAFilter ? (float_emaFastLine < float_emaSlowLine) : true

float_avgVolume = ta.sma(volume, 20)
bool_volumeConfirm = bool_useVolumeFilter ? (volume > float_avgVolume * float_volumeMultiplier) : true

// --- é£é™©ç®¡ç†è®¡ç®— ---
float_atrValue = ta.atr(int_atrLength)
float_volatility = ta.stdev(close, 20) / ta.sma(close, 20)
float_normalizedVol = float_volatility / ta.sma(float_volatility, 50)
float_positionSize = bool_useVolatilityPosition ? math.max(10.0, math.min(20.0, float_basePositionSize / math.max(float_normalizedVol, 0.8))) : float_basePositionSize

// === ğŸš€ REVOLUTIONARY RELEASE WINDOW MECHANISM ===

// 1. Detect Squeeze Release Event
bool_squeezeReleaseEvent = bool_sqzOn[1] and not bool_sqzOn

// 2. Open Release Window on Squeeze Release (FIXED: ç«‹å³å¼€å¯)
if (bool_squeezeReleaseEvent)
    int_windowCountdown := int_releaseWindow
    bool_inReleaseWindow := true
    bool_windowSignalTriggered := false  // Reset for new window
    int_windowStartBar := bar_index
    int_totalWindows += 1  // Statistics
    
// ğŸ”§ FIX: ç¡®ä¿åœ¨æŒ¤å‹é‡Šæ”¾çš„å½“å‰Kçº¿å°±å¼€å¯çª—å£
bool_inReleaseWindow := bool_squeezeReleaseEvent or bool_inReleaseWindow

// 3. Window Countdown and Closure
if (bool_inReleaseWindow)
    int_windowCountdown -= 1
    if (int_windowCountdown <= 0)
        bool_inReleaseWindow := false

// === ğŸ”§ CRITICAL FIX: é‡‡ç”¨v1.5çš„ç›´æ¥ä¿¡å·æ£€æµ‹ ===

// åŸºæœ¬æŒ¤å‹é‡Šæ”¾ä¿¡å· (å®Œå…¨æŒ‰ç…§v1.5é€»è¾‘)
bool_signalBar = bool_squeezeReleaseEvent  // ç›´æ¥æ£€æµ‹ï¼Œæ— çª—å£çº¦æŸ

// v1.5åŸºæœ¬ä¿¡å·
bool_basicLongSignal = bool_signalBar and float_momentum > 0 and float_wt1 > float_wt2
bool_basicShortSignal = bool_signalBar and float_momentum < 0 and float_wt1 < float_wt2

// v1.5ç®€åŒ–ä¿¡å·
bool_simpleLongSignal = bool_signalBar and float_momentum > 0
bool_simpleShortSignal = bool_signalBar and float_momentum < 0

// v1.5æ³¢æ®µå¢å¼ºä¿¡å·
bool_swingLongSignal = bool_basicLongSignal and (not bool_useEMAFilter or bool_emaBullTrend) and (not bool_useVolumeFilter or bool_volumeConfirm)
bool_swingShortSignal = bool_basicShortSignal and (not bool_useEMAFilter or bool_emaBearTrend) and (not bool_useVolumeFilter or bool_volumeConfirm)

// ğŸ¯ LEGACY VARIABLES (for compatibility with existing visualizations)
bool_coreSignalLong = bool_basicLongSignal  // Map to v1.5 basic signal
bool_coreSignalShort = bool_basicShortSignal  // Map to v1.5 basic signal

// === ä¸‰æ¨¡å¼æœ€ç»ˆä¿¡å·å†³ç­– (é€»è¾‘ä¿æŒä¸€è‡´) ===
bool_finalLongSignal = false
bool_finalShortSignal = false

// === v1.5åŸç‰ˆä¿¡å·é€‰æ‹©é€»è¾‘ ===
if (string_signalMode == "Ultra" or bool_useSimplifiedSignals)
    // è¶…ç®€åŒ–æ¨¡å¼ï¼šä»…æ£€æµ‹æŒ¤å‹é‡Šæ”¾ + åŠ¨é‡
    bool_finalLongSignal := bool_simpleLongSignal
    bool_finalShortSignal := bool_simpleShortSignal
else
    // é»˜è®¤æ¨¡å¼ï¼šä½¿ç”¨v1.5çš„æ³¢æ®µå¢å¼ºä¿¡å·
    bool_finalLongSignal := bool_swingLongSignal
    bool_finalShortSignal := bool_swingShortSignal

// === é˜²é‡å¤è§¦å‘æœºåˆ¶ (å·²ç¦ç”¨ä»¥ä¿è¯æœ€å¤§ä¿¡å·é¢‘ç‡) ===
// æ³¨é‡Šæ‰é˜²é‡å¤æœºåˆ¶ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨v1.5çš„ç›´æ¥æ£€æµ‹
// if (bool_preventDuplicates and bool_windowSignalTriggered)
//     bool_finalLongSignal := false
//     bool_finalShortSignal := false

// --- æ–¹å‘è¿‡æ»¤ ---
bool_longSignalFiltered = (string_tradeDirection != "Short Only") and bool_finalLongSignal
bool_shortSignalFiltered = (string_tradeDirection != "Long Only") and bool_finalShortSignal

// --- Near Miss åˆ†æ (ç®€åŒ–ç‰ˆæœ¬) ---
bool_nearMissLong_EMA = bool_basicLongSignal and not bool_emaBullTrend
bool_nearMissLong_Volume = bool_basicLongSignal and not bool_volumeConfirm

bool_nearMissShort_EMA = bool_basicShortSignal and not bool_emaBearTrend
bool_nearMissShort_Volume = bool_basicShortSignal and not bool_volumeConfirm

// === çŠ¶æ€ç®¡ç†å’Œäº¤æ˜“æ‰§è¡Œ ===

// --- çŠ¶æ€è·Ÿè¸ª ---
var bool bool_waitLongExitBySqueeze = false
var bool bool_waitShortExitBySqueeze = false
var float float_longStopPrice = na
var float float_shortStopPrice = na

// å†³å®šé€€å‡ºæ¡ä»¶ç±»å‹å’Œæ ‡è®°çª—å£å·²è§¦å‘
if (bool_longSignalFiltered and strategy.position_size == 0)
    bool_waitLongExitBySqueeze := (float_momentum > float_momentum[1])
    float_longStopPrice := bool_useStopLoss ? close - (float_atrValue * float_atrMultiplier) : na
    // bool_windowSignalTriggered := bool_preventDuplicates  // å·²ç¦ç”¨
    int_totalWindowSignals += 1  // Statistics

if (bool_shortSignalFiltered and strategy.position_size == 0)
    bool_waitShortExitBySqueeze := (float_momentum < float_momentum[1])
    float_shortStopPrice := bool_useStopLoss ? close + (float_atrValue * float_atrMultiplier) : na
    // bool_windowSignalTriggered := bool_preventDuplicates  // å·²ç¦ç”¨
    int_totalWindowSignals += 1  // Statistics

// --- åè½¬å’Œé€€å‡ºä¿¡å· ---
bool_squeezeBackIn = bool_sqzOn and not bool_sqzOn[1]

bool_exitLongWeak = strategy.position_size > 0 and not bool_waitLongExitBySqueeze and (float_momentum < 0)
bool_exitShortWeak = strategy.position_size < 0 and not bool_waitShortExitBySqueeze and (float_momentum > 0)

bool_exitLongSqueeze = strategy.position_size > 0 and bool_waitLongExitBySqueeze and bool_squeezeBackIn
bool_exitShortSqueeze = strategy.position_size < 0 and bool_waitShortExitBySqueeze and bool_squeezeBackIn

bool_longStopHit = bool_useStopLoss and strategy.position_size > 0 and not na(float_longStopPrice) and close <= float_longStopPrice
bool_shortStopHit = bool_useStopLoss and strategy.position_size < 0 and not na(float_shortStopPrice) and close >= float_shortStopPrice

bool_longExitCondition = bool_exitLongWeak or bool_exitLongSqueeze or bool_longStopHit
bool_shortExitCondition = bool_exitShortWeak or bool_exitShortSqueeze or bool_shortStopHit

// --- äº¤æ˜“æ‰§è¡Œ ---
if (bool_longSignalFiltered)
    strategy.entry("Long", strategy.long, qty=float_positionSize, comment="4S Long RW")

if (bool_shortSignalFiltered)
    strategy.entry("Short", strategy.short, qty=float_positionSize, comment="4S Short RW")

if (bool_longExitCondition)
    strategy.close("Long", comment="Exit Long")

if (bool_shortExitCondition)
    strategy.close("Short", comment="Exit Short")

// é‡ç½®çŠ¶æ€
if (strategy.position_size == 0)
    bool_waitLongExitBySqueeze := false
    bool_waitShortExitBySqueeze := false
    float_longStopPrice := na
    float_shortStopPrice := na

// === ğŸš€ REVOLUTIONARY VISUALIZATION ===

// --- Release Window Visual System ---
bgcolor(bool_showWindowVisuals and bool_inReleaseWindow ? color.new(color.blue, 95) : na, title="ğŸš€ Release Window")

// Release event markers
plotshape(bool_showWindowVisuals and bool_squeezeReleaseEvent, title="ğŸš€ Squeeze Release", location=location.top, color=color.new(color.orange, 0), style=shape.arrowup, size=size.small, text="ğŸš€", textcolor=color.orange)

// Window countdown labels
if (bool_showWindowVisuals and bool_inReleaseWindow)
    label.new(bar_index, high * 1.01, str.tostring(int_windowCountdown), style=label.style_circle, color=color.new(color.blue, 20), textcolor=color.white, size=size.tiny)

// --- Core Signal Visualization ---
// v1.5 Signal Layers (simplified)
plotshape(bool_showAllSignals and bool_simpleLongSignal, title="Simple Long Signal", location=location.belowbar, color=color.new(color.lime, 70), style=shape.circle, size=size.large)
plotshape(bool_showAllSignals and bool_simpleShortSignal, title="Simple Short Signal", location=location.abovebar, color=color.new(color.red, 70), style=shape.circle, size=size.large)

// v1.5 Basic Signals (CORE - medium triangles)
plotshape(bool_showAllSignals and bool_basicLongSignal, title="Basic Long Signal", location=location.belowbar, color=color.new(color.green, 30), style=shape.triangleup, size=size.normal)
plotshape(bool_showAllSignals and bool_basicShortSignal, title="Basic Short Signal", location=location.abovebar, color=color.new(color.red, 30), style=shape.triangledown, size=size.normal)

// v1.5 Swing Signals (+ EMA/Volume - small diamonds)
plotshape(bool_showAllSignals and bool_swingLongSignal, title="Swing Long Signal", location=location.belowbar, color=color.new(color.blue, 20), style=shape.diamond, size=size.small)
plotshape(bool_showAllSignals and bool_swingShortSignal, title="Swing Short Signal", location=location.abovebar, color=color.new(color.purple, 20), style=shape.diamond, size=size.small)

// æœ€ç»ˆäº¤æ˜“ä¿¡å· (æ·±è‰², çªå‡ºæ˜¾ç¤º)
plotshape(bool_longSignalFiltered, title="ğŸ¯ FINAL Long Entry", location=location.belowbar, color=color.new(color.green, 0), style=shape.triangleup, size=size.normal)
plotshape(bool_shortSignalFiltered, title="ğŸ¯ FINAL Short Entry", location=location.abovebar, color=color.new(color.red, 0), style=shape.triangledown, size=size.normal)

// Near Miss ä¿¡å·
plotshape(bool_nearMissLong_EMA, title="Near Miss: EMA Failed", location=location.belowbar, color=color.new(color.yellow, 40), style=shape.square, size=size.tiny)
plotshape(bool_nearMissLong_Volume, title="Near Miss: Volume Failed", location=location.belowbar, color=color.new(color.orange, 40), style=shape.square, size=size.tiny)

// é€€å‡ºä¿¡å·
plotshape(bool_longExitCondition and strategy.position_size > 0, title="Exit Long", location=location.belowbar, color=color.new(color.gray, 0), style=shape.xcross, size=size.tiny)
plotshape(bool_shortExitCondition and strategy.position_size < 0, title="Exit Short", location=location.abovebar, color=color.new(color.gray, 0), style=shape.xcross, size=size.tiny)

// EMAçº¿æ¡
plot(bool_useEMAFilter ? float_emaFastLine : na, "EMA Fast", color.new(color.blue, 30), 1)
plot(bool_useEMAFilter ? float_emaSlowLine : na, "EMA Slow", color.new(color.orange, 30), 1)

// æ­¢æŸçº¿
plot(strategy.position_size > 0 and not na(float_longStopPrice) ? float_longStopPrice : na, "Long Stop", color.red, 1, plot.style_stepline)
plot(strategy.position_size < 0 and not na(float_shortStopPrice) ? float_shortStopPrice : na, "Short Stop", color.red, 1, plot.style_stepline)

// === ğŸš€ ENHANCED STATUS PANEL ===
if barstate.islast and bool_showStatusPanel
    var table table_status = table.new(position.top_right, 3, 16, border_width=1)
    
    // è¡¨å¤´
    table.cell(table_status, 0, 0, "4S v1.7.3 âœ… True Fix", bgcolor=color.new(color.blue, 10), text_color=color.white, text_size=size.normal)
    table.cell(table_status, 1, 0, "Value", bgcolor=color.new(color.blue, 10), text_color=color.white)
    table.cell(table_status, 2, 0, "Status", bgcolor=color.new(color.blue, 10), text_color=color.white)
    
    // ğŸš€ Release Window Status (NEW!)
    string_windowStatus = bool_inReleaseWindow ? ("ACTIVE (" + str.tostring(int_windowCountdown) + ")") : "CLOSED"
    table.cell(table_status, 0, 1, "ğŸš€ Window", text_color=color.black)
    table.cell(table_status, 1, 1, string_windowStatus, 
              bgcolor=bool_inReleaseWindow ? color.new(color.green, 70) : color.new(color.gray, 70), 
              text_color=color.white)
    table.cell(table_status, 2, 1, bool_inReleaseWindow ? "ğŸŸ¢" : "âš«", text_color=color.white)
    
    // ä¿¡å·æ¨¡å¼
    table.cell(table_status, 0, 2, "Mode", text_color=color.black)
    table.cell(table_status, 1, 2, string_signalMode, bgcolor=color.new(color.purple, 70), text_color=color.white)
    table.cell(table_status, 2, 2, "", text_color=color.black)
    
    // å‹ç¼©çŠ¶æ€
    string_sqzStatus = bool_sqzOn ? "ON" : bool_sqzOff ? "OFF" : "NO"
    table.cell(table_status, 0, 3, "Squeeze", text_color=color.black)
    table.cell(table_status, 1, 3, string_sqzStatus, bgcolor=bool_sqzOn ? color.new(color.red, 70) : bool_sqzOff ? color.new(color.green, 70) : color.new(color.gray, 70))
    table.cell(table_status, 2, 3, bool_squeezeReleaseEvent ? "ğŸš€" : (bool_sqzOff ? "âœ“" : "âœ—"), bgcolor=bool_squeezeReleaseEvent ? color.new(color.orange, 70) : (bool_sqzOff ? color.new(color.green, 70) : color.new(color.red, 70)), text_color=color.white)
    
    // åŠ¨é‡æ–¹å‘
    table.cell(table_status, 0, 4, "Momentum", text_color=color.black)
    table.cell(table_status, 1, 4, str.tostring(float_momentum, "#.###"), bgcolor=float_momentum > 0 ? color.new(color.green, 70) : color.new(color.red, 70), text_color=color.white)
    table.cell(table_status, 2, 4, float_momentum > 0 ? "ğŸŸ¢" : "ğŸ”´", text_color=color.white)
    
    // WaveTrendçŠ¶æ€
    table.cell(table_status, 0, 5, "WaveTrend", text_color=color.black)
    table.cell(table_status, 1, 5, float_wt1 > float_wt2 ? "UP" : "DOWN", bgcolor=float_wt1 > float_wt2 ? color.new(color.green, 70) : color.new(color.red, 70), text_color=color.white)
    table.cell(table_status, 2, 5, float_wt1 > float_wt2 ? "ğŸŸ¢" : "ğŸ”´", text_color=color.white)
    
    // ğŸ¯ Core Signal Status (NEW!)
    table.cell(table_status, 0, 6, "ğŸ¯ Core Signal", text_color=color.black)
    string_coreSignal = bool_coreSignalLong ? "LONG" : bool_coreSignalShort ? "SHORT" : "NONE"
    table.cell(table_status, 1, 6, string_coreSignal,
              bgcolor=bool_coreSignalLong ? color.new(color.green, 70) : bool_coreSignalShort ? color.new(color.red, 70) : color.new(color.gray, 70),
              text_color=color.white)
    table.cell(table_status, 2, 6, bool_basicLongSignal or bool_basicShortSignal ? "ğŸ¯" : "âš«", text_color=color.white)
    
    // EMAè¶‹åŠ¿
    table.cell(table_status, 0, 7, "EMA Trend", text_color=color.black)
    string_trendStatus = bool_useEMAFilter ? (bool_emaBullTrend ? "BULL" : "BEAR") : "OFF"
    table.cell(table_status, 1, 7, string_trendStatus,
              bgcolor=bool_useEMAFilter ? (bool_emaBullTrend ? color.new(color.green, 70) : color.new(color.red, 70)) : color.new(color.gray, 70),
              text_color=color.white)
    table.cell(table_status, 2, 7, bool_emaBullTrend ? "ğŸŸ¢" : "ğŸ”´", text_color=color.white)
    
    // æˆäº¤é‡ç¡®è®¤
    table.cell(table_status, 0, 8, "Volume", text_color=color.black)
    table.cell(table_status, 1, 8, str.tostring(volume/float_avgVolume, "#.##") + "x", bgcolor=bool_volumeConfirm ? color.new(color.green, 70) : color.new(color.red, 70), text_color=color.white)
    table.cell(table_status, 2, 8, bool_volumeConfirm ? "ğŸŸ¢" : "ğŸ”´", text_color=color.white)
    
    // æœ€ç»ˆä¿¡å·
    table.cell(table_status, 0, 9, "Final Signal", text_color=color.black)
    string_finalSignal = bool_longSignalFiltered ? "LONG" : bool_shortSignalFiltered ? "SHORT" : "NONE"
    table.cell(table_status, 1, 9, string_finalSignal, bgcolor=bool_longSignalFiltered ? color.new(color.green, 70) : bool_shortSignalFiltered ? color.new(color.red, 70) : color.new(color.gray, 70), text_color=color.white)
    table.cell(table_status, 2, 9, bool_longSignalFiltered or bool_shortSignalFiltered ? "ğŸ¯" : "âš«", text_color=color.white)
    
    // ğŸš€ Anti-Duplicate Status (NEW!)
    table.cell(table_status, 0, 10, "ğŸš« Anti-Dup", text_color=color.black)
    string_dupStatus = bool_preventDuplicates ? (bool_windowSignalTriggered ? "USED" : "READY") : "OFF"
    table.cell(table_status, 1, 10, string_dupStatus, bgcolor=bool_preventDuplicates ? (bool_windowSignalTriggered ? color.new(color.red, 70) : color.new(color.green, 70)) : color.new(color.gray, 70), text_color=color.white)
    table.cell(table_status, 2, 10, bool_preventDuplicates ? (bool_windowSignalTriggered ? "ğŸš«" : "âœ…") : "âš«", text_color=color.white)
    
    // === ğŸš€ WINDOW STATISTICS (NEW!) ===
    if (bool_showWindowStats)
        // Total Windows
        table.cell(table_status, 0, 11, "ğŸ“Š Total Windows", text_color=color.black)
        table.cell(table_status, 1, 11, str.tostring(int_totalWindows), bgcolor=color.new(color.blue, 70), text_color=color.white)
        table.cell(table_status, 2, 11, "ğŸ“Š", text_color=color.white)
        
        // Window Signals
        table.cell(table_status, 0, 12, "ğŸ¯ Window Signals", text_color=color.black)
        table.cell(table_status, 1, 12, str.tostring(int_totalWindowSignals), bgcolor=color.new(color.green, 70), text_color=color.white)
        table.cell(table_status, 2, 12, "ğŸ¯", text_color=color.white)
        
        // Window Efficiency
        float_windowEfficiency = int_totalWindows > 0 ? (int_totalWindowSignals / int_totalWindows) * 100 : 0
        table.cell(table_status, 0, 13, "âš¡ Efficiency %", text_color=color.black)
        table.cell(table_status, 1, 13, str.tostring(float_windowEfficiency, "#.#") + "%", bgcolor=float_windowEfficiency > 50 ? color.new(color.green, 70) : float_windowEfficiency > 25 ? color.new(color.yellow, 70) : color.new(color.red, 70), text_color=color.white)
        table.cell(table_status, 2, 13, float_windowEfficiency > 50 ? "âš¡" : float_windowEfficiency > 25 ? "âš ï¸" : "ğŸ”´", text_color=color.white)

// === è­¦æŠ¥æ¡ä»¶ ===
alertcondition(bool_squeezeReleaseEvent, "ğŸš€ Release Window Opened", "4S v1.7.3: Release window opened - monitoring for signals!")
alertcondition(bool_coreSignalLong, "ğŸ¯ Core Long Signal", "4S v1.7.3: Core long signal detected!")
alertcondition(bool_coreSignalShort, "ğŸ¯ Core Short Signal", "4S v1.7.3: Core short signal detected!")
alertcondition(bool_longSignalFiltered, "ğŸ“ˆ Final Long Signal", "4S v1.7.3: FINAL long signal - ready to trade!")
alertcondition(bool_shortSignalFiltered, "ğŸ“‰ Final Short Signal", "4S v1.7.3: FINAL short signal - ready to trade!")
alertcondition(bool_nearMissLong_EMA or bool_nearMissLong_Volume, "âš ï¸ Near Miss Long", "4S v1.7.3: Near miss long signal - watch for improvement!")
alertcondition(bool_longExitCondition or bool_shortExitCondition, "ğŸšª Exit Signal", "4S v1.7.3: Exit condition triggered!")
alertcondition(bool_useSimplifiedSignals and bool_simpleLongSignal, "âš¡ Ultra Long Signal", "4S v1.7.3: Ultra simplified long signal - maximum frequency!")
alertcondition(bool_useSimplifiedSignals and bool_simpleShortSignal, "âš¡ Ultra Short Signal", "4S v1.7.3: Ultra simplified short signal - maximum frequency!")

// === End of Four Swords v1.7.3 True Fix - v1.5 Signal Logic Restored âœ… ===