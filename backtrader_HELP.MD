# Backtrader 4倍逐仓杠杆交易实现指南

## 📋 基础配置

### 环境要求
- **虚拟环境**: `backtester\venv`
- **框架**: Backtrader Python回测框架

## 💰 资金与仓位管理

### 核心逻辑
- **初始资金**: 500 USDT
- **每笔交易保证金**: 100 USDT (占总资金20%)
- **杠杆倍数**: 4倍
- **名义仓位价值**: 400 USDT (保证金 × 杠杆)

### 正确的仓位计算公式
```python
# 正确逻辑
account_value = broker.getvalue()        # 账户权益 (如500 USDT)
margin = account_value * 0.20           # 保证金 (100 USDT)
leverage = 4                            # 杠杆倍数
nominal_value = margin * leverage       # 名义价值 (400 USDT)
position_size = nominal_value / price   # 实际仓位大小
```

### ❌ 常见错误
```python
# 错误逻辑 - 直接用20%计算名义价值
target_value = account_value * 0.20     # 错误！这是保证金不是名义价值
size = target_value / price             # 错误！杠杆没有体现
```

## 🛡️ 风险控制与爆仓机制

### 爆仓检测逻辑
Backtrader不会自动处理爆仓，需要在策略中实现：

```python
# 爆仓检测逻辑
entry_price = self.position.price          # 开仓价格
current_price = self.data.close[0]         # 当前价格
margin_used = entry_value / leverage       # 已用保证金
unrealized_pnl = position_size * (current_price - entry_price)

# 多头爆仓条件：浮亏 >= 保证金
if unrealized_pnl <= -margin_used:
    self.close()  # 强制平仓
    # 损失限定在保证金内 (20%资金)
```

### 强平价格计算
```python
# 多头仓位强平价格
liquidation_price = entry_price * (1 - 1/leverage)
# 4倍杠杆下，价格下跌25%触发强平
```

## ⚙️ Backtrader配置

### Commission设置
```python
cerebro.broker.setcommission(
    commission=0.0002,      # 手续费率 (0.02%)
    margin=0.25,            # 保证金比例 (25% = 4倍杠杆)
    leverage=4.0,           # 杠杆倍数
    stocklike=False         # 期货模式
)
```

### 仓位管理器
```python
class LeverageSizer(bt.Sizer):
    def _getsizing(self, comminfo, cash, data, isbuy):
        account_value = self.broker.getvalue()
        margin = account_value * self.p.risk_pct  # 20%资金作保证金
        leverage = self.p.leverage                # 4倍杠杆
        nominal_value = margin * leverage         # 名义价值
        return nominal_value / data.close[0]      # 仓位大小
```

## 🔄 交易流程控制

### 单仓位限制
```python
# 确保同一时刻仅1笔持仓
def next(self):
    if self.position.size == 0:  # 无持仓时才能开新仓
        # 执行开仓逻辑
        pass
    else:
        # 监控现有仓位，检查爆仓条件
        self._check_liquidation()
```

### 逐仓隔离
- **资金隔离**: 每笔交易损失最大为投入保证金 (20%资金)
- **无追缴**: 爆仓后不扣除其他资金，剩余80%资金继续交易
- **独立计算**: 每笔交易的盈亏独立计算

## 📊 账户权益动态

### 净值计算
- **浮动盈亏**: 实时反映在 `broker.getvalue()` 中
- **已实现盈亏**: 平仓后加入账户余额
- **最大回撤**: 关注单次爆仓是否导致净值下降20%

### 风险指标监控
```python
# 关键风险指标
max_drawdown = analyzers.drawdown.max.drawdown  # 最大回撤
total_trades = analyzers.trades.total.total     # 总交易数
win_rate = analyzers.trades.won.total / total_trades  # 胜率
```

## ⚠️ 重要注意事项

### 数据匹配
- **时间框架**: 确保数据频率与策略逻辑一致 (如4H K线)
- **数据完整性**: 验证OHLCV数据无缺失
- **时区处理**: 统一时间基准

### 费用模拟
- **交易手续费**: 0.02% - 0.05% (Maker/Taker差异)
- **资金费率**: 合约独有，可选择性模拟
- **滑点**: 根据市场流动性设置

### 回测验证
- **多周期测试**: 不同时间框架验证策略稳定性
- **极端行情**: 确保爆仓机制在大幅下跌时正确触发
- **资金曲线**: 验证每次爆仓损失确实限定在20%以内