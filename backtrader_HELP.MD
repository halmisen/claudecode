# Backtrader 4å€é€ä»“æ æ†äº¤æ˜“å®ç°æŒ‡å—

## ğŸ“‹ åŸºç¡€é…ç½®

### ç¯å¢ƒè¦æ±‚
- **è™šæ‹Ÿç¯å¢ƒ**: `backtester\venv`
- **æ¡†æ¶**: Backtrader Pythonå›æµ‹æ¡†æ¶

## ğŸ’° èµ„é‡‘ä¸ä»“ä½ç®¡ç†

### æ ¸å¿ƒé€»è¾‘
- **åˆå§‹èµ„é‡‘**: 500 USDT
- **æ¯ç¬”äº¤æ˜“ä¿è¯é‡‘**: 100 USDT (å æ€»èµ„é‡‘20%)
- **æ æ†å€æ•°**: 4å€
- **åä¹‰ä»“ä½ä»·å€¼**: 400 USDT (ä¿è¯é‡‘ Ã— æ æ†)

### æ­£ç¡®çš„ä»“ä½è®¡ç®—å…¬å¼
```python
# æ­£ç¡®é€»è¾‘
account_value = broker.getvalue()        # è´¦æˆ·æƒç›Š (å¦‚500 USDT)
margin = account_value * 0.20           # ä¿è¯é‡‘ (100 USDT)
leverage = 4                            # æ æ†å€æ•°
nominal_value = margin * leverage       # åä¹‰ä»·å€¼ (400 USDT)
position_size = nominal_value / price   # å®é™…ä»“ä½å¤§å°
```

### âŒ å¸¸è§é”™è¯¯
```python
# é”™è¯¯é€»è¾‘ - ç›´æ¥ç”¨20%è®¡ç®—åä¹‰ä»·å€¼
target_value = account_value * 0.20     # é”™è¯¯ï¼è¿™æ˜¯ä¿è¯é‡‘ä¸æ˜¯åä¹‰ä»·å€¼
size = target_value / price             # é”™è¯¯ï¼æ æ†æ²¡æœ‰ä½“ç°
```

## ğŸ›¡ï¸ é£é™©æ§åˆ¶ä¸çˆ†ä»“æœºåˆ¶

### çˆ†ä»“æ£€æµ‹é€»è¾‘
Backtraderä¸ä¼šè‡ªåŠ¨å¤„ç†çˆ†ä»“ï¼Œéœ€è¦åœ¨ç­–ç•¥ä¸­å®ç°ï¼š

```python
# çˆ†ä»“æ£€æµ‹é€»è¾‘
entry_price = self.position.price          # å¼€ä»“ä»·æ ¼
current_price = self.data.close[0]         # å½“å‰ä»·æ ¼
margin_used = entry_value / leverage       # å·²ç”¨ä¿è¯é‡‘
unrealized_pnl = position_size * (current_price - entry_price)

# å¤šå¤´çˆ†ä»“æ¡ä»¶ï¼šæµ®äº >= ä¿è¯é‡‘
if unrealized_pnl <= -margin_used:
    self.close()  # å¼ºåˆ¶å¹³ä»“
    # æŸå¤±é™å®šåœ¨ä¿è¯é‡‘å†… (20%èµ„é‡‘)
```

### å¼ºå¹³ä»·æ ¼è®¡ç®—
```python
# å¤šå¤´ä»“ä½å¼ºå¹³ä»·æ ¼
liquidation_price = entry_price * (1 - 1/leverage)
# 4å€æ æ†ä¸‹ï¼Œä»·æ ¼ä¸‹è·Œ25%è§¦å‘å¼ºå¹³
```

## âš™ï¸ Backtraderé…ç½®

### Commissionè®¾ç½®
```python
cerebro.broker.setcommission(
    commission=0.0002,      # æ‰‹ç»­è´¹ç‡ (0.02%)
    margin=0.25,            # ä¿è¯é‡‘æ¯”ä¾‹ (25% = 4å€æ æ†)
    leverage=4.0,           # æ æ†å€æ•°
    stocklike=False         # æœŸè´§æ¨¡å¼
)
```

### ä»“ä½ç®¡ç†å™¨
```python
class LeverageSizer(bt.Sizer):
    def _getsizing(self, comminfo, cash, data, isbuy):
        account_value = self.broker.getvalue()
        margin = account_value * self.p.risk_pct  # 20%èµ„é‡‘ä½œä¿è¯é‡‘
        leverage = self.p.leverage                # 4å€æ æ†
        nominal_value = margin * leverage         # åä¹‰ä»·å€¼
        return nominal_value / data.close[0]      # ä»“ä½å¤§å°
```

## ğŸ”„ äº¤æ˜“æµç¨‹æ§åˆ¶

### å•ä»“ä½é™åˆ¶
```python
# ç¡®ä¿åŒä¸€æ—¶åˆ»ä»…1ç¬”æŒä»“
def next(self):
    if self.position.size == 0:  # æ— æŒä»“æ—¶æ‰èƒ½å¼€æ–°ä»“
        # æ‰§è¡Œå¼€ä»“é€»è¾‘
        pass
    else:
        # ç›‘æ§ç°æœ‰ä»“ä½ï¼Œæ£€æŸ¥çˆ†ä»“æ¡ä»¶
        self._check_liquidation()
```

### é€ä»“éš”ç¦»
- **èµ„é‡‘éš”ç¦»**: æ¯ç¬”äº¤æ˜“æŸå¤±æœ€å¤§ä¸ºæŠ•å…¥ä¿è¯é‡‘ (20%èµ„é‡‘)
- **æ— è¿½ç¼´**: çˆ†ä»“åä¸æ‰£é™¤å…¶ä»–èµ„é‡‘ï¼Œå‰©ä½™80%èµ„é‡‘ç»§ç»­äº¤æ˜“
- **ç‹¬ç«‹è®¡ç®—**: æ¯ç¬”äº¤æ˜“çš„ç›ˆäºç‹¬ç«‹è®¡ç®—

## ğŸ“Š è´¦æˆ·æƒç›ŠåŠ¨æ€

### å‡€å€¼è®¡ç®—
- **æµ®åŠ¨ç›ˆäº**: å®æ—¶åæ˜ åœ¨ `broker.getvalue()` ä¸­
- **å·²å®ç°ç›ˆäº**: å¹³ä»“ååŠ å…¥è´¦æˆ·ä½™é¢
- **æœ€å¤§å›æ’¤**: å…³æ³¨å•æ¬¡çˆ†ä»“æ˜¯å¦å¯¼è‡´å‡€å€¼ä¸‹é™20%

### é£é™©æŒ‡æ ‡ç›‘æ§
```python
# å…³é”®é£é™©æŒ‡æ ‡
max_drawdown = analyzers.drawdown.max.drawdown  # æœ€å¤§å›æ’¤
total_trades = analyzers.trades.total.total     # æ€»äº¤æ˜“æ•°
win_rate = analyzers.trades.won.total / total_trades  # èƒœç‡
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### æ•°æ®åŒ¹é…
- **æ—¶é—´æ¡†æ¶**: ç¡®ä¿æ•°æ®é¢‘ç‡ä¸ç­–ç•¥é€»è¾‘ä¸€è‡´ (å¦‚4H Kçº¿)
- **æ•°æ®å®Œæ•´æ€§**: éªŒè¯OHLCVæ•°æ®æ— ç¼ºå¤±
- **æ—¶åŒºå¤„ç†**: ç»Ÿä¸€æ—¶é—´åŸºå‡†

### è´¹ç”¨æ¨¡æ‹Ÿ
- **äº¤æ˜“æ‰‹ç»­è´¹**: 0.02% - 0.05% (Maker/Takerå·®å¼‚)
- **èµ„é‡‘è´¹ç‡**: åˆçº¦ç‹¬æœ‰ï¼Œå¯é€‰æ‹©æ€§æ¨¡æ‹Ÿ
- **æ»‘ç‚¹**: æ ¹æ®å¸‚åœºæµåŠ¨æ€§è®¾ç½®

### å›æµ‹éªŒè¯
- **å¤šå‘¨æœŸæµ‹è¯•**: ä¸åŒæ—¶é—´æ¡†æ¶éªŒè¯ç­–ç•¥ç¨³å®šæ€§
- **æç«¯è¡Œæƒ…**: ç¡®ä¿çˆ†ä»“æœºåˆ¶åœ¨å¤§å¹…ä¸‹è·Œæ—¶æ­£ç¡®è§¦å‘
- **èµ„é‡‘æ›²çº¿**: éªŒè¯æ¯æ¬¡çˆ†ä»“æŸå¤±ç¡®å®é™å®šåœ¨20%ä»¥å†…